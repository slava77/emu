<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en" dir="ltr" >
<head>
<title>EMU CSC Online DQM Results Browser</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<style type="text/css">
	body {
		color: #000000; 
		background-color: #8080FF;
		margin: 2px;
		font-family:Arial;
		overflow: auto;
	}
	a, A:link, a:visited, a:active, A:hover	{
			color: #000000; 
			text-decoration: none;		
			outline-style: none;			
	}
		
	fieldset {
		background-color: #ddd;	
			
		border-style: solid;
		border-width: 1px;
		border-color: black;
		margin: 2px;
		padding: 2px;
		overflow: auto;
		
	}
	
	
	legend {
		border-style: solid;
		border-width: 1px;		
		background-color:  #C0C0FF;				
	}
	legend:hover {
		background-color: white;
	}
	
	label {
		font-weight: bold;
	}
	
	
	
	table {		
		border-color: black;		
		background-color: #AFAFAF;			
		border-collapse: collapse;
		background-color: #bbb;
		border-width: 1px;
		border-spacing: 0px;
		border-style: solid;	
		margin: 1px;
		
	}
	
	
	
	tr, th, td {
		vertical-align: top;
		border: 1px solid black;
		
	}
	td, th {
		border: 1px solid black;
		font-size:8pt; ;
		padding: 0px;
	}
	
	
	
	
	div.tabs {
		float: none;
	}
	
	div.tabs ul {
		list-style: none;
		padding: 0;
		margin: 0;
		
	}

	div.tabs li {
		font-size: 12px;
		float: left;
		border: 1px solid;
		border-bottom-width: 0;
		margin: 0 0.5em 0 0;
		background-color: #9F9F9F;
	}

	div.tabs a {
		display: block;
		padding: 0 1em;
		
	}

	div.tabs #selected, #selected:active, #selected_runs, #selected_runs:active {
		font-weight: bold;
		position: relative;
		top: 1px;
		background-color: white;
		
	}
	
	
	div#report_entry_div {
		max-height: 100px;			
		overflow: auto;
	}
	
	
	div#tests_div 
	{		
		max-height: 500px;		
		max-width: 300px;
		overflow: auto;
	}
	
	div#runs_list
	{
		max-height: 132px;			
		overflow-x: hidden;
		overflow-y: scroll;
	}
		
	
	div#slideshow_div {
		max-height: 400px;
		overflow: auto;
	}
	
	div#log {
		max-height: 200px;
		overflow: auto;
	}
	
	table.log {
		border-collapse: collapse;
		background-color: #ccc;
		border-width: 1px;
		border-spacing: 0px;
		border-style: solid;
		margin: 2px;
	}
	table.log th {background-color: #AFAFFF; text-align: left; padding: 0 2px 0 2px;}
	table.log tr {border-style: solid; background-color:#E0E0E0;}
	td.log {font-size:8pt; font-family:Arial; padding: 0 2px 0 2px; border-style: solid;}	
	span#debug {color: black; font-weight: bold;}
	span#info  {color: green; font-weight: bold;}
	span#error {color: orange; font-weight: bold;}
	span#warn  {color: orange; font-weight: bold;}
	
	span.SEVERITY_NONE {background-color: yellowgreen; font-weight: bold;}
	span.SEVERITY_MINOR  {background-color: yellow; font-weight: bold;}
	span.SEVERITY_TOLERABLE {background-color: lightpink; font-weight: bold;}
	span.SEVERITY_SEVERE  {background-color: orange; font-weight: bold;}
	span.SEVERITY_CRITICAL  {background-color: red; font-weight: bold;}
	
	li.sshow_list { font-size:8pt; font-family:Arial; margin: 0;}
	
	table.dqm_report {
		background-color: #F0F0F0;
	}
	
	a.winTitle {
		margin: 0;
		font-size: 12px;
		font-weight: bold;
		text-decoration: none;
		color: #000080;		
	}
	
	a.add_to_list {		
		font-weight: bold;
		color: green;
		background: white;
	}	
	a.remove_from_list {		
		font-weight: bold;
		color: red;
		background: white;
	}
	a.test_help, span.show_icon {		
		font-weight: bold;
		color: white;
		background: #50D050;
	}	
	table.runs_table, table.tests_table {
		width: 100%;
		border-collapse: collapse;
		background-color: #bbb;
		border-width: 1px;
		border-spacing: 0px;
		border-style: solid;	
		margin: 1px;
	}
	
	table.runs_table tr, td {text-align: left; white-space: nowrap;}
	table.runs_table th {padding: 0 0 0 4px; text-align: left; font-weight: bold; background-color: #AFAFFF; } 
	
	table.nodes_table tr, td {white-space: nowrap; }
	td.node_info {background-color: white; text-align: center; }
	
	#csctable_div, #hwtable_div, #runs_div, #tests_div, #csccounters_div,
	#local_runs, #global_runs, #online_runs, #ddutable_div, #report_div
	{
		padding: 1px;
		border-style: solid;
		border-width: 1px;
		border-color: black;
		background-color: white;
		clear: left;
		overflow:auto;
	}
	
	div#report_entry_div {
		max-height: 100px;			
		overflow: auto;
	}
	
	
	#csctable_div, #hwtable_div, #csccounters_div,#ddutable_div {
		float: left;
	}
	
	#hwtable_div, #csccounters_div, #ddutable_div, #report_div {
		max-height: 350px;
	}
	
	#csc_table {
		border-collapse: collapse;
		background-color: #bbb;
		border-width: 1px;
		border-spacing: 0px;
		border-style: solid;
		margin: 2px;
	}
	
	#csc_table td {
		text-align: center;
		
	}
	
	legend.t_hdr, a.test_hdr {
		font-size: 9pt;
		font-weight: bold;
		background-color: #ddd;
		
	}
	a.test_hdr2 {
		font-size: 8pt;
		font-weight: bold;
		background-color: #ddd;
		
		
		
	}
	
	td.hw_tr {font-size: 10pt; font-weight: bold; background-color: #ddd;}
	td.hw_td {background-color: white; text-align: center;}
	
	td.me_csc, td.me_ddu { width: 18px; background-color: #8C8C8C}
	td.me_type{ background-color: #ddd; font-weight: bold;  width: 40px;} 
	td.me, td.me_emu { background-color: #ddd; font-weight: bold; font-size:9pt; width: 50px; }	
	th.RunLink {padding: 0 0 0 4px; text-align: left; font-size:10pt;  font-weight: bold; background-color: #AFAFFF; } 
	td.node {width: 24px; background-color: white; text-align: center; }
	td.td_status {background-color: white; text-align: center}
	th.repScope {padding: 0 0 0 4px; text-align: left; font-size:10pt;  font-weight: bold; background-color: #AFAFFF; }
	
	table.page_layout {
		
		border-spacing: 2px;
		background-color: #6060FF;
		
	}
	table.page_layout tr, table.page_layout th, table.page_layout td {
		vertical-align: top;
		
	}
	
</style>
<script type="text/javascript">

// var baseURL="http://cms-csc.web.cern.ch/cms-csc/DQM/DAQ/plots/merged/";
var baseURL="";
var getPlot="getPlot";
var getRefPlot="getRefPlot";
var TestsList="getTestsList";
var CSCList="getCSCList";
var NodesStatus="getNodesStatus";
var CSCCounters="getCSCCounters";
var controlDQM="controlDQM";

// Maps
var CSCMap="redir?url=csc_map.js";
var DDUMap="redir?url=ddu_csc_map.js";
var VMEMap="redir?url=vme_pc_map.js";
var TestsMap="redir?url=tests_map.js";
// var RunsList="redir?url=runs_list.js";
var RunsList="getRunsList";

// DQM Reports
var TextReport="redir?url=dqm_report.txt";
// var JSONReport="redir?url=dqm_report.js";
var JSONReport="getDQMReport";
var reportWindow = "";

var imgFormat=".png";
var RunNumber="Online";
var RunName="Online";
var Folder="";
var RunInfoIdx = -1;
var Canvas="";
var Scope="";
var isFolderValid=false;
var postfix = ".plots";

var updateImageInterval=10000; 

var minImageHeight=100;
var maxImageHeight=1200;
var minImageWidth=100;
var maxImageWidth=1900;
var imgHeight=600;
var imgWidth=800;
var imgSizeStep=40;

var RUNS=false;	// list of Runs
var TREE_RUNS=false; //  actually list of Tests/Canvases
var CSCMAP=false;
var CSC_LIST=false;
var DDUMAP=false;
var NODES_LIST=false;

var CSC_COUNTERS=false;
var TESTS_MAP=false;
var DQM_REPORT=false;
var NODES_SAVED=false;

var Log=new Array();
var logLevel="all";

var isIE = false;

var selectedObjectList=new Array();

var testsShowLists = new Array();
testsShowLists["Custom"] = new Array();
var runsShowLists = new Array();
runsShowLists["Custom"] = new Array();
var foldersShowLists = new Array();
foldersShowLists["Selected Only"] = new Array();
foldersShowLists["All CSCs"] = new Array();
// foldersShowLists["Custom"] = new Array();
var folderSListIdx=0;
var fOpenExternal=false;
var loopFoldersFirst = true;
var fAutoUpdatePlot = false;
var fShowReference = false;
var selFolder="";
var selNode="";

var EMUs = new Array();
var DDUs = new Array();
var CSCs = new Array();


var updateCounters = new Array();
var NodesHistory = new Array();
var histDepth=200;
var numCSCs=0;
var numDDUs=0;
var getNodesListDelay=10;
var getCSCListDelay=20;
var totalDAQevents=0;
var totalDQMevents=0;
var totalCSCblocks=0;
var totalDQMrate=0;
var totalCSCrate=0;

var DQM_SEVERITY = 
	[
	{"name": "NONE", "color": "yellowgreen"},
	{"name": "MINOR", "color": "yellow"},
	{"name": "TOLERABLE", "color": "lightpink"},
	{"name": "SEVERE", "color": "orange"},
	{"name": "CRITICAL", "color": "red"}
	];

var CSC_TYPES = [
	['ME+',[
		["ME+4/2", 36],
		["ME+4/1", 18],
		["ME+3/2", 36],
		["ME+3/1", 18],
		["ME+2/2", 36],
		["ME+2/1", 18],
		["ME+1/3", 36],
		["ME+1/2", 36],
		["ME+1/1", 36]]
	],
	['ME-',[["ME-1/1", 36],
		["ME-1/2", 36],
		["ME-1/3", 36],
		["ME-2/1", 18],
		["ME-2/2", 36],
		["ME-3/1", 18],
		["ME-3/2", 36],
		["ME-4/1", 18],
		["ME-4/2", 36]]
	]
];

function addPadding(num,count,pad)
{
	var numStr = num + '';
	while(numStr.length < count) {
	numStr = pad + numStr;
	}
	return numStr;
}

function printNodeStatusLegend()
{
	var out = "<table class='dqm_report'><tr>";
        out += "<td><b>Status legend:</b></td>";
	out += "<td><span style='background-color: #ffff90;'>Ready/Configured</span></td>";
	out += "<td><span style='background-color: #90ff90;'>Enabled/Started</span></td>";
	out += "<td><span style='background-color: #ff9090;'>Halted/Stopped</span></td>";
	out += "<td><span style='background-color: white;'>Dead</span></td>";
	out += "<td><span style='background-color: #C0C0C0;'>Disabled</span></td>";
	
        out += "</tr></table>";
        return out;
}

function printReportLegend()
{
	var out = "<table class='dqm_report'><tr>";
	out += "<td><b>Severity legend:</b> ";
	for (var i=0; i<DQM_SEVERITY.length; i++) {
		out += " <span class='SEVERITY_"+DQM_SEVERITY[i].name+"'>" + DQM_SEVERITY[i].name + "</span> ";
	}
	out += "</td></tr></table>";
	return out; 
}

function loadPlot() {
	// var imgurl = Folder+"/"+Canvas;
	// var objname = Canvas.substr(Canvas.search("/"), Canvas.length);
	var objname = Canvas.substr(0, Canvas.search(".png"));
	if (objname.search("/") >=0) objname = objname.substr(objname.search("/")+1, objname.length);
	var timestamp=new Date()
	var imgurl=baseURL+getPlot+"?objectName="+objname+"&folder="+Folder+"&imageWidth="+imgWidth+"&imageHeight="+imgHeight+"&run="+RunName+"&timestamp="+timestamp.getTime();
	var zoomimage=baseURL+getPlot+"?objectName="+objname+"&folder="+Folder+"&imageWidth="+1600+"&imageHeight="+1200+"&run="+RunName+"&timestamp="+timestamp.getTime();
//	var ref_imgurl =baseURL+getRefPlot+"?folder="+Folder+"&plot="+Canvas;
	var ref_imgurl=baseURL+getPlot+"?objectName="+objname+"&folder="+Folder+"&imageWidth="+imgWidth+"&imageHeight="+imgHeight+"&run=ref&timestamp="+timestamp.getTime();
	var out = "";
	var title = "Plots";
	// addlog(Folder +"/"+objname, "info"); 
			
	
	if (!isFolderValid) {
			
		// out += RunNumber+": Invalid folder - \""+Folder+"\"<hr>";
	} else {
		if ((parent.Folder != "") && (parent.Canvas != "") ) {
			if ((Folder.search("EMU") >=0 && Scope == "EMU") || 
				(Folder.search("DDU") >=0 && Scope == "DDU") || 
				(Folder.search("CSC") >=0 && parent.Scope == "CSC")) {
				// out += RunNumber+": \""+Folder+"/"+Canvas+"\"<hr>";				
				title += ": " +RunName+"/"+Folder+"/"+Canvas;
				// addlog(title, "info")
				// out += "<a target=blank href=\'"+imgurl+"\'><IMAGE height='"+imgHeight+"' NAME='test' SRC='"+imgurl+"'></a>";
				// dirtypop();				
				if (fOpenExternal) {
					try {
						var generator=window.open('','name','height='+(imgHeight+90)+',width='+(imgWidth+40)+',resizable=no');						
						if (window.focus) {generator.focus()} 
						generator.resizeTo(imgWidth+20, imgHeight+90);
						generator.document.write('<html><head><title>'+title+'</title>');
						generator.document.write("<style>body {color: #000000; background-color: #9090FF;margin: 2px;font-family:Arial;	overflow: auto;}"+
						"span.winTitle {	margin: 0;font-size: 12px;font-weight: bold;text-decoration: none;color: #000000;}"+
						"fieldset {background-color: #ddd;	border-style: solid;border-width: 1px;border-color: black;margin: 2px;padding: 2px;}"+
						"legend {border-style: solid;border-width: 1px;background-color:  #C0C0FF;}</style>");
						generator.document.write('</head><body>');
						generator.document.write("<fieldset><legend><span class='winTitle'>"+title+"</span></legend>");
						generator.document.write("<IMAGE NAME='test' SRC='"+imgurl+"'>");
						generator.document.write("</fieldset>");
						// generator.document.write('<p><a href="javascript:self.close()">Close</a> the popup.</p>');
						generator.document.write('</body></html>');
						generator.document.close();
					  } 
					  catch (exc){
					}
				} else {
					out += "<a target=blank href=\'"+zoomimage+"\'><IMAGE NAME='test' SRC='"+imgurl+"'></a>";
				}
				
				if (fShowReference) {
					try {
						var generator=window.open('','ref_name','height=640,width=800,resizable=true');
						if (window.focus) {generator.focus()}
						var ref_title = "Reference Plots: " +Folder+"/"+Canvas;
						generator.document.write('<html><head><title>'+ref_title+'</title>');
						generator.document.write("<style>body {color: #000000; background-color: #90FF90;margin: 2px;font-family:Arial;	overflow: auto;}"+
						"span.winTitle {	margin: 0;font-size: 12px;font-weight: bold;text-decoration: none;color: #000000;}"+
						"fieldset {background-color: #ddd;	border-style: solid;border-width: 1px;border-color: black;margin: 2px;padding: 2px;}"+
						"legend {border-style: solid;border-width: 1px;background-color:  #C0FFC0;}</style>");
						generator.document.write('</head><body>');
						generator.document.write("<fieldset><legend><span class='winTitle'>"+ref_title+"</span></legend>");
				/*		generator.document.write("<span style='color: #FF0000'><blink>Warning: These Reference Plots are not certified yet!!!</blink></span><br>"); */
						generator.document.write("<IMAGE NAME='test' SRC='"+ref_imgurl+"'>");
						generator.document.write("</fieldset>");
						// generator.document.write('<p><a href="javascript:self.close()">Close</a> the popup.</p>');
						generator.document.write('</body></html>');
						generator.document.close();
					} 
					catch (exc){
					}
					
				}
				
			}else {
				addlog("Can not display '"+Canvas+"'. Selected canvas scope '"+Scope+"' and folder '"+Folder+"' logical sections mismatch", "warn");
				// addlog("Invalid canvas: \""+RunNumber+"/"+Folder+"/"+Canvas, "error");
				// out += "Invalid canvas: \""+Folder+"/"+Canvas+"\"<hr>";
			} 
		} 
	}
	var o_obj = document.getElementById("plots_div");
	if (o_obj) o_obj.innerHTML = out;
	o_obj = document.getElementById("plot_title");
	if (o_obj) o_obj.innerHTML = title;
	return false;
}

function updatePlots() {
	if (fAutoUpdatePlot) {
		loadPlot();
		setTimeout('updatePlots()',updateImageInterval);
	}
}

function showHide(id)
{
   obj = document.getElementById(id);
   if (obj) {
	if (obj.style.display == 'none') obj.style.display = '';
	else obj.style.display = 'none';
   }
   return false;
}

function getTime()
{
	var t = new Date();
	val = t.getDate()
	date = (val<10)?'0'+val:val;
	val = t.getMonth()+1;
	month = (val<10)?'0'+val:val;
	year = t.getFullYear();	
	val = t.getHours();
	hour = (val<10)?'0'+val:val;
	val = t.getMinutes();
	minute = (val<10)?'0'+val:val;
	val = t.getSeconds();
	sec = (val<10)?'0'+val:val;
	time_str = date+"/"+month+"/"+year+" "+hour+":"+minute+":"+sec;
	return time_str;
}

function addlog(message, level)
{
	if (Log) {
		var entry = new Array();
		entry[0] = getTime();
		entry[1] = level;
		entry[2] = message;
		Log.push(entry);
		showLog();
	}
/*	var logd = document.getElementById("log");
	if (logd) {
        log_text = logd.innerHTML;
		
        msg = '<tr><td class="log">'+getTime()+'</td><td><span class="log" id=\"'+level+'\">'+level.toUpperCase()+ '</span></td><td><span class="log">' +message+'</span></td></tr><br>' + log_text;
		//msg = '<li class="log" id=\"'+level+'\">'+level.toUpperCase()+ ": " +message+'</li>' + log_text;
		logd.innerHTML = msg;
	}
	return false;
	*/
}

function showLog()
{
	var logd = document.getElementById("log");
	if (Log && logd && !isIE) {
		logd.style.display = "none";
		logd.innerHTML = "";
		var out = "<table class='log'>";
		if (Log.length >0) 
			out += "<tr><th>Date/Time</th><th>Level</th><th>Message</th></tr>";
		
		for (var i=Log.length-1; i>=0; i--) {
			if (Log[i] && Log[i].length==3) {
				level = Log[i][1];
				if (level == logLevel || logLevel == "all") {
					out += '<tr><td class="log">'+Log[i][0]+'</td><td class="log"><span class="log" id=\"'+Log[i][1]+'\">'+Log[i][1].toUpperCase()+ '</span></td><td width="100%" class="log">' +Log[i][2]+'</td></tr>';
				}
			}
		}
		out +="</table>";
		logd.style.display = "block";
		logd.innerHTML = out;
	}
}

function selectLogLevel()
{
	var selObj = document.getElementById("selLogLevel");
	if (selObj) {
		var selIdx = selObj.selectedIndex;
		selList = selObj.options[selIdx].value;
		logLevel = selList;		
		// addlog(selList, "info");
		showLog();
	}
}

function clearLog() 
{
	Log.length = 0;
	showLog();
/*	var logd = document.getElementById("log");
	if (logd) {
        logd.innerHTML = "";
	}
	return false;
	*/
}
function resetCSCTable(c_table)
{
	DDUs.length = 0;
	clearShowList("Folders", "All CSCs");
	var ct = document.getElementById(c_table);
	if (ct) {
		var tds = ct.getElementsByTagName("td");	
		for (var i=0; i< tds.length; i++) {
			// var style=tds[i].style;
			if (tds[i].getAttribute("class")) {
				if (tds[i].getAttributeNode("class").value == "me_csc") {
					id = tds[i].getAttributeNode("id").value;	
					tds[i].style.background = '#AFAFAF';
					tds[i].innerHTML = id.substr(id.lastIndexOf("\/")+1,id.length);
					// tds[i].style = style;
										
				}
				if (tds[i].getAttributeNode("class").value == "me_emu") {
					id = tds[i].getAttributeNode("id").value;					
					tds[i].innerHTML = "EMU Summary";					
				}
				if (tds[i].getAttributeNode("class").value == "me_ddu") {
					id = tds[i].getAttributeNode("id").value;
					tds[i].style.background = '#AFAFAF';
					tds[i].innerHTML = id.substr(id.lastIndexOf("U")+1,id.length);
					// tds[i].style = style;
										
				}
			}			
		}
	}
}

function showCSCTable(id)
{
	var c_list = CSC_TYPES;
	obj = document.getElementById(id);
	if (obj) {
		if (c_list && c_list.length > 0) {
			// obj.innerHTML = "";
			out = "";
			out += "<table border=1 cellpadding=0 cellspacing=0 id='csc_table'>";
			out += "<th class='RunLink' id='RunLink' colspan=38 align=left>Run:</th>";
			
			// Display Commons
			out += "<tr class='me'><td id='cscCommon' class='me_emu' colspan='2' >EMU Summary</td><td colspan='36'></td></tr>";
			
			// Display DDUs 
			out += "<tr class='me'><td id='cscDDU' class='me' colspan='2' >DDUs</td>";			
			for (var i=1; i<= 36; i++) {
				out += "<td id='cscDDU"+addPadding(i,2,'0')+"' class='me_ddu' >"+i+"</td>";
			}
			out += "</tr>";
			
			// Display CSCs
			for (var i=0; i< c_list.length; i++) 
			{
				if (c_list[i] && c_list[i].length > 0) {
					var side = c_list[i][0];
			 		out += "<tr class='me'><td rowspan='9' id='"+side+"' class='me' >"+side+"</td>";
					
					var types =  c_list[i][1];
					if (types && types.length > 0) {
						for (var j=0; j< types.length; j++) {			
							var csctype = types[j][0];
							if (j>0) out+= "<tr class='me_type'>";
							out += "<td id='"+csctype+"' class='me_type' >"+csctype+"</td>";		
							var num_cscs = types[j][1];

							for (var k=1; k<= num_cscs; k++) {
								if (num_cscs==18) 
									out += "<td class='me_csc' id='"+(csctype+"/"+addPadding(k,2,'0'))+"' colspan='2'>"+k+"</td>";
								else 
									out += "<td class='me_csc' id='"+(csctype+"/"+addPadding(k,2,'0'))+"'>"+k+"</td>";
								
							}
							if (j>0) out += "</tr>";
						}
					}
					out += "</tr>";		
				}
			}
			out += "</table>";
			out += printReportLegend();
			obj.innerHTML = out;
		}
	}
}

function showDDUTable(id)
{
	// DDUs.length = 0;
	// clearShowList("Folders", "All CSCs");
	var c_list = DDUMAP;
	
	
	obj = document.getElementById(id);
	if (obj) {
		if (c_list && c_list.length > 0) {
			// obj.innerHTML = "";
			out = "";
			out += "<table border=1 cellpadding=0 cellspacing=0 id='ddumap_table'>";
			// out += "<th class='RunLink' id='RunLink' colspan=38 align=left>Run Number: </th>";
			// out += "<th class='RunLink' align=left colspan=38>Run Number: <a class='RLink' target=images href="+link+">"+RunNumber+"</a><br></th>";
			// Display Commons
			
			
			// Display DDUs 
			//out += "<tr class='me'><td id='cscDDU' class='me' colspan='2' >DDUs</td>";	
			out += "<tr><td class='me_type'>RUI#</td><td class='me_type'>DDU ID</td>";
			for (var i=0; i<15; i++) {
				out += "<td class='me_type'>Inp "+i+"</td>";
			};
			out += "</tr>";
			for (var i=0; i<= c_list.length; i++) {
				out += "<tr class='me'>";
				rui = c_list[i];
				if (rui && rui.length) {
					out += "<td class='me_type' id='cscRUI"+i+"' class='me_ddu' >"+rui[1]+"</td>";
					out += "<td class='me_type' >"+rui[0]+"</td>";
					for (var j=4; j<19; j++) {
						out += "<td id='csc"+rui[j]+"'>"+rui[j]+"</td>";
					}
				}
				out += "</tr>";
			}
			
			
			
			out += "</table>";
			obj.innerHTML = out;
		}
	}
}

function findLinkedDDU(id)
{
	if (DDUMAP && DDUMAP.length) {
		for (var i=0; i<DDUMAP.length; i++) {
			rui = DDUMAP[i];
			for (var j=4; j<19; j++){
				if (rui[j]==id) {
					showConnectedCSCs(i+1);
					return false;
				}
			}
		}
	}
}

function showConnectedCSCs(id)
{
	// updateCSCMappings();
	// loadDQMReport("report_div");
	// addlog("DDU"+id, "info");
	if (DDUMAP && DDUMAP.length) {
		rui=DDUMAP[id-1];
		if (rui && rui.length) {
			/*
			obj = document.getElementById("cscDDU"+id);
			if (obj) {
				obj.style.borderColor = "red";
				obj.style.borderWidth = "2px";
			}
			*/
			for (var i=4; i<19; i++) {
				cscid="csc"+rui[i];
				if (rui[i] != "") {
					obj = document.getElementById(cscid);
					if (obj) {
						// obj.style.borderColor = "red";
						obj.style.background = "yellowgreen";
						//obj.style.borderWidth = "2px";
					}
					/*
					obj = document.getElementById(rui[i]);
					if (obj) {
						obj.style.borderColor = "red";
						obj.style.borderWidth = "2px";
						
					}
					*/
				}
			}
		}
	}
}


function makeCSCid(crate, slot)
{
	var cscid="CSC_";
	var crateID=crate.substr(5,crate.length);
	var slotID=slot.substr(4,slot.length);
	if (crateID.length==1) crateID='00'+crateID;
	if (crateID.length==2) crateID='0'+crateID;
	if (slotID.length==1) slotID='0'+slotID;
	cscid += crateID+"_"+slotID;
	return cscid;
}

function showHWTable() 
{	
	r_list = CSC_LIST;
	csc_map = CSCMAP;
	ddu_map = DDUMAP;
	var link = "";
	var out = "";	
	
	out += "<table class='hw_table'>";
	
	
	isFolderValid=false;
	if (r_list && r_list.length >0) {
		crates = r_list[0];
		
		// RunNumber = r_list[0][0];		
		out += "<th class='RunLink' align=left colspan=0><a class='RLink' target=images href="+link+">Run: "+RunNumber+"</a><br></th>";
		for (var i=1; i<crates.length; i++) {
			crate = crates[i][0];
			if (crate=="crate255") continue;		
			if (crate=="EMU") { 
				Tag = crates[i][1];
				ID = "hw_"+Tag;
				out += "<tr><td class='hw_td'><a href=''  id=\'"+ID+"\' onClick='Folder=\""+Tag+"\"; selectSystemFolder(\""+Tag+"\");return loadPlot();'>EMU Summary</a></td>";
				if (Folder.search("EMU") >=0) isFolderValid = true;						
				//EMUs.push(Tag);
				continue;
			}
			if (crate=="DDU") { 
				
				ddu_list = crates[i][1];
				if (ddu_list.length > 0) {
					out += "<tr><td class='hw_tr'>DDUs</td>";
				for(var j=0; j< ddu_list.length; j++) {
					if (ddu_list[j]) {
					  	if ((j/9) && (j%9==0)) out += "</tr><tr><td></td>";	
						Tag = ddu_list[j];						
						idx = getDDUindex(Tag);
						ID = "hw_"+Tag;						
						if (Folder.search(Tag) >=0) isFolderValid = true;
						var name=Tag;
						for (var k=0; k<ddu_map.length; k++) {
							map_entry = ddu_map[k];
							if (!map_entry) continue;
							if (map_entry[0] && map_entry[0] == ddu_list[j]) //{name += "<br>rui"+map_entry[1]+"/c"+map_entry[2]+"/s"+map_entry[3];}								
								{name += "<br>("+idx+") c"+map_entry[2]+"/s"+map_entry[3];}
						}
						out += "<td class='hw_td'><a href='' id=\'"+ID+"\' onClick='Folder=\""+Tag+"\"; selectSystemFolder(\""+Tag+"\"); return loadPlot();'>"+name+"</a></td>";
						// dduLink="<a href='#' id='" + dduID+ "' onClick='Folder=\""+entry+"\"; selectDDUFolder(\""+idx+"\"); return loadPlot();'>"+idx+"</a>";
						// DDUs.push(Tag);
					}
				}						
					out += "</tr>";
					
				}
				continue;
			}
			
			crate_str=getVMECrateName(crate) + ": "+crate;
			out += "<tr><td class='hw_tr'><b>"+crate_str+"</b></td>";
			// out += "<tr><td class='hw_tr'><b>"+crate+"</b></td>";
			slots = crates[i][1];
			for (var j=0; j<slots.length; j++) {
				if (slots[j]) {
					// Tag = crate+"/"+slots[j];
					Tag=makeCSCid(crate, slots[j]);
					ID = "hw_"+Tag;
					if (!isFolderValid && (Folder == Tag)) isFolderValid=true;
					//CSCs.push(Tag);
					cscid = "";
					for (var k=0; k<csc_map.length; k++) {
						if (!csc_map[k]) continue;
						map_entry = csc_map[k];
						if ((map_entry[0] == crate) && (map_entry[1] == slots[j])) {cscid = "<br>"+map_entry[2];}
					}
					
					
					// csclink="<a href='#' id='" + ID+ "' onClick='Folder=\""+Tag+"\"; return loadFrame(\""+ID+"\",false, 1)'>"+slots[j]+cscid+"</a>";
					csclink="<a href='' id='" + ID+ "' onClick='Folder=\""+Tag+"\"; selectSystemFolder(\""+Tag+"\"); return loadPlot();'>"+slots[j]+cscid+"</a>";
					out += "<td class='hw_td'>"+csclink+"</td>";
				}
			}
			out += "</tr>";
		}
	
	}
	out += "</table>";
	
	var o_obj = document.getElementById("hwtable_div");
	if (o_obj) o_obj.innerHTML = out;
	// if (parent.isFolderValid) 
	// select(Folder, false, 1 );

}

// Load Available offline Runs list

function showNodeDetailedStatus(id) {
	var out="";
	var nodes=NODES_LIST;
	obj = document.getElementById("nodestatus_div");
	if (nodes && nodes.length>1) {
		var idx=false;
		for (i=1; i<nodes.length; i++) {
			if (nodes[i] && nodes[i].length) {
				node = nodes[i][0].substr(nodes[i][0].lastIndexOf('-')+1,nodes[i][0].length);
				if (node == id) idx=i;
			}
		}
		if (obj && nodes[idx] && nodes[idx].length && idx) {
			out +="<table class='nodes_table'>";
			// Show Table Header
			if (nodes.length && nodes[0] && nodes[0].length) {
				for (i=0; i< nodes[0].length; i++) {
					out+="<th>"+nodes[0][i]+"</th>";
				}
			}
			// Show Node Status 
			out+="<tr>";
			out+="<td class='node_info'><a target='shownode' href='"+nodes[idx][1]+"'>"+nodes[idx][0]+"</a></td>";
			state = nodes[idx][2];
			id = 'node_'+node;
			var color='white';
			if (state.search("Enabled") >=0) {color='#90ff90';}
			else if (state.search("Halted") >=0) {color='#ff9090';}
			else if (state.search("Ready") >=0) {color='#ffff90';}
			else if (state.search("Unknown") >=0) {color='909090';}
			
			out +="<td class='node_info' style='background-color: "+color+"'>"+state+"</td>";
			for (j=3; j<nodes[idx].length; j++) {
				out+="<td class='node_info'>"+nodes[idx][j]+"</td>";
			}
			out+="</tr>";
			out +="</table>"	
			obj.innerHTML=out;
		} else {
			if (selNode != "") addlog("Selected Monitor node "+selNode+" is down", "warn");
			selNode="";
			obj.innerHTML="";
		}
	}
	return false;
}

function showNodeInfo(id)
{
	obj = document.getElementById("nodestatus_div");
	if (obj) {
		if (id == selNode) {
			if (obj.style.display == 'none') obj.style.display = '';
			else obj.style.display = 'none';
		} else {
			obj.style.display = '';
		}	
		/*obj.style.position = "absolute";
		obj.style.left=300;// window.event.clientX;
		obj.style.top=100; // window.event.clientY+10;
		*/
	}
   return false;
	
}

function addToNodesHistory(nodes)
{
		var time = new Date();
		var tstamp= time.getHours()+":"+time.getMinutes()+":"+time.getSeconds();
		// entry=nodes;
		// entry.push(tstamp);
		idx = NodesHistory.push(nodes);
		// NodesHistory[idx-1].push(tstamp);
		if (NodesHistory.length>histDepth) NodesHistory.shift();
}

function showRateHistory(id) {
	var title="Rate history for Node:" + id;
	// addlog(NodesHistory.length, "debug");
	// return false;
	/*
	for (i=0; i<NodesHistory.length; i++)  {
			// addlog(NodesHistory.length, "debug");
		
			entry= NodesHistory[i];
			if (entry && entry.length) {
				for (j=0; j<entry.length; j++) {
					node_entry = entry[j];
					if (node_entry && node_entry.length) {
						node = node_entry[0].substr(node_entry[0].lastIndexOf('-')+1,node_entry[0].length);
						if (node== id) {
							rate = node_entry[6];							
							addlog(node+":"+rate, "debug");
						}
					}
				}
			}
		}
	return false;
	*/
	try {
		var generator=window.open('/rates','name','height='+100+',width='+200+',resizable=yes');						
		if (window.focus) {generator.focus()} 
		generator.document.write('<html><head><title>'+title+'</title>');
		generator.document.write("<style>body {color: #000000; background-color: #9090FF;margin: 2px;font-family:Arial;	overflow: auto;}"+
		"span.winTitle {	margin: 0;font-size: 12px;font-weight: bold;text-decoration: none;color: #000000;}"+
		"fieldset {background-color: #ddd;	border-style: solid;border-width: 1px;border-color: black;margin: 2px;padding: 2px;}"+
		"legend {border-style: solid;border-width: 1px;background-color:  #C0C0FF;}</style>");
		generator.document.write('</head><body>');
		generator.document.write("<fieldset><legend><span class='winTitle'>"+title+"</span></legend>");
		
		
		for (var i=0; i<NodesHistory.length; i++)  {
		
			// generator.document.write(NodesHistory.length+"<br>");
			
			entry= NodesHistory[i];
			if (entry && entry.length) {
				for (j=0; j<entry.length; j++) {
					node_entry = entry[j];
					if (node_entry && node_entry.length) {
						node = node_entry[0].substr(node_entry[0].lastIndexOf('-')+1,node_entry[0].length);
						if (node== id) {
							rate = node_entry[6];	
							// time = entry[entry.length-1];
							generator.document.write(rate+"<br>");
							// addlog(node+":"+rate, "debug");
						}
					}
				}
			}
			
		}
		
		generator.document.write("</fieldset>");
		// generator.document.write('<p><a href="javascript:self.close()">Close</a> the popup.</p>');
		generator.document.write('</body></html>');
		generator.document.close();
	  } 
	  catch (exc){
	}
	return false;
}

function sendDQMAction(action) 
{
  var fullUrl = baseURL + controlDQM;
	params = "?action="+action;
	fullUrl+=params;
	var req=false;
	if (window.XMLHttpRequest) { 
		/*
		try {
	    		netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite");
	   	} catch (e) {
	    		alert("Permission UniversalBrowserRead denied.");
	   	}
		*/
	    req = new XMLHttpRequest();    
	   
	} else if (window.ActiveXObject) {    
		//req = new ActiveXObject("Microsoft.XMLDOM");
	    req = new ActiveXObject((navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) ? "Microsoft.XMLHTTP" : "Msxml2.XMLHTTP");
		// var req = new ActiveXObject("Microsoft.XMLHTTP");
	}
    req.open("GET",fullUrl,true); // true= asynch, false=wait until loaded    
	
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
			if (req.status==200) {	        
				var reply = req.responseText;
				addlog("Sent DQM command "+action, "info");
				// setDQMStatus(action);
				req=false;				
	    	} else if (req.status==404) {
				addlog("Unable to send DQM command "+action, "error");
				//setDQMStatus("Unable " + action);
	    	}
						
		}
    }
	req.send(null);	
	// addlog("Update Nodes List", "info");
	return false;
}

function setDQMStatus(msg)
{
	obj = document.getElementById("dqm_control_status");
	if (obj) {
		obj.innerHTML = msg;
	}
}

function updateNodesStatus()
{
	
	var out="";
	var nodes=NODES_LIST;
	obj = document.getElementById("nodesview_div");
	if (obj) {

			
		var out = printNodeStatusLegend();
		out += "<table>";	
		nodeclass="EmuMonitor"
		out +="<tr><td><b>" + nodeclass + "s:</b></td>";
		for (var i=1; i<=36; i++) {
			color="#C0C0C0";
			node=i;
			out +="<td class='node' style='background-color: "+color+"' id='node_"+i+"'>"+node+"</td>";
		}
		out +="</tr>";
		out +="<tr>";
		out +="<tr><td><b>Rate Evt/s:</b></td>";
		for (var i=1; i<=36; i++) {
			rate="-";
			out +="<td class='node' id='rate_node_"+i+"'>"+rate+"</td>";
		}
		out +="</tr>";
		out +="<tr>";
		out +="<tr><td><b>Rate CSC/s:</b></td>";
		for (var i=1; i<=36; i++) {
			rate="-";
			out +="<td class='node' id='csc_rate_node_"+i+"'>"+rate+"</td>";
			
		}
		out +="</tr>";
		out +="</table>";
		obj.innerHTML=out;
	
		var isDead = false;	
		if (nodes) {
			addToNodesHistory(nodes);
			if (nodes.length>1) {		
				totalDAQevents=0;
				totalDQMevents=0;
				totalCSCblocks=0;
				totalDQMrate=0;
				totalCSCrate=0;
				for (i=1; i<nodes.length; i++) {
					if (!nodes[i]) continue;
					node = nodes[i][0].substr(nodes[i][0].lastIndexOf('-')+1,nodes[i][0].length);
					state = nodes[i][2];
					rate = nodes[i][6];
					csc_rate = nodes[i][9];
					RunNumber=nodes[i][3];
					// id = 'node_'+node;
					id=node;
					node = "<a href='' onClick='showNodeDetailedStatus(\""+node+"\");showNodeInfo(\""+node+"\");selectNode(\""+node+"\");return false;'>"+node+"</a>";
					var color='white';
					if (state.search("Enabled") >=0) {color='#90ff90';}
					else if (state.search("Halted") >=0) {color='#ff9090';}
					else if (state.search("Ready") >=0) {color='#ffff90';}
					else if (state.search("NA") >=0) {color='white';}
					cell = document.getElementById('node_'+id); 
					if (cell){
						cell.innerHTML=node;
						cell.style.background = color;
					}
					cell = document.getElementById('rate_node_'+id); 
					if (cell){
						cell.innerHTML=rate;					
					}
					cell = document.getElementById('csc_rate_node_'+id); 
					if (cell){
						cell.innerHTML=csc_rate;
					
					}
					
					if (NODES_SAVED && NODES_SAVED[i] && NODES_SAVED[i][2])
					{
						if ( (state.search("NA") >=0) && (NODES_SAVED[i][2].search("NA") < 0) )	
						{
							isDead = true;
						}
					}

					totalDAQevents += parseInt(nodes[i][4]);
					totalDQMevents += parseInt(nodes[i][5]);
					totalDQMrate += parseInt(nodes[i][6]);
					totalCSCblocks += parseInt(nodes[i][8]);
					totalCSCrate += parseInt(nodes[i][9]);
					
				}
			}
		}
	
		if (isDead) alert("Some of the DQM EmuMonitors modules just died!\nReload and Restart Local DQM!");	
		NODES_SAVED = NODES_LIST;
	}	

}

function getNodesList()
{
	var fullUrl = baseURL + NodesStatus;
	getNodesListDelay=10;
	var req=false;
	if (window.XMLHttpRequest) { 
		/*
		try {
	    		netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite");
	   	} catch (e) {
	    		alert("Permission UniversalBrowserRead denied.");
	   	}
		*/
	    req = new XMLHttpRequest();    
	   
	} else if (window.ActiveXObject) {    
		//req = new ActiveXObject("Microsoft.XMLDOM");
	    req = new ActiveXObject((navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) ? "Microsoft.XMLHTTP" : "Msxml2.XMLHTTP");
		// var req = new ActiveXObject("Microsoft.XMLHTTP");
	}
    req.open("GET",fullUrl,true); // true= asynch, false=wait until loaded    
	
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
			if (req.status==200) {	        
				var reply = req.responseText;
				// Need to strip malformed array string to satisfy IE7
				reply = reply.replace(/,]/g,"]");
				reply = reply.replace("var ","");
	        	window.eval(reply);
				updateNodesStatus();
				selectNode(selNode);
				showNodeDetailedStatus(selNode);
				req=false;
				
	    	} else if (req.status==404) {
	    	}
						
		}
    }
	req.send(null);	
	setTimeout('getNodesList()', 10000);
	// addlog("Update Nodes List", "info");
	return false;
}

function getTestsList()
{
	var fullUrl = baseURL + TestsList+"?run="+RunName;
	
	
	var req=false;
	if (window.XMLHttpRequest) { 
		/*
		try {
	    		netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite");
	   	} catch (e) {
	    		alert("Permission UniversalBrowserRead denied.");
	   	}
		*/
	    req = new XMLHttpRequest();    
	   
	} else if (window.ActiveXObject) {    
		//req = new ActiveXObject("Microsoft.XMLDOM");
	    req = new ActiveXObject((navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) ? "Microsoft.XMLHTTP" : "Msxml2.XMLHTTP");
		// var req = new ActiveXObject("Microsoft.XMLHTTP");
	}
    req.open("GET",fullUrl,true); // true= asynch, false=wait until loaded    
	
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
			if (req.status==200) {	        
				var reply = req.responseText;
				// Need to strip malformed array string to satisfy IE7
				reply = reply.replace(/,]/g,"]");
				reply = reply.replace("var ","");
	        	window.eval(reply);
				loadTestsList (TREE_ITEMS, "tests_div");
				// addlog(reply, 'debug');
				updateBrowserPage(Canvas,false,3);				
				// updateBrowserPage(id,false,2);
	    	} else if (req.status==404) {
				addlog("Can not load " + fullUrl, 'error');
	    	}
						
		}
    }
	req.send(null);	
	return false;
}

// Load Avai;able Tests/Canvases ist
function loadTestsList(r_list, id) 
{
	obj = document.getElementById(id);
	if (obj) {
		if (r_list) {
			out = "";
			for (var i = 0; i< r_list.length; i++) {
				// document.write("<tr><td><b>"+r_list[i][0]+"</b></td></tr>");
				if (!r_list[i]) continue;
				out += "<fieldset>";
				
				th_folder = r_list[i][0];
				th_id = "folder_"+ th_folder;
				out += "<legend class='t_hdr'><a class='test_hdr' href='' onClick='return showHide(\""+th_id+"\");'>"+th_folder+"</a></legend>";
				if (r_list[i][0] == "EMU") 
					{ scope = "EMU";}
				else if (r_list[i][0] == "DDU") 
					{ scope = "DDU";}
				else 
					{scope = "CSC";}
				var child = [];				
				child=r_list[i];
				out += "<div class='t_div' id='"+th_id+"' style='overflow: hidden;'>";
				t_map = [];
				for (var j=2; j<child.length; j++) {
					if (!child[j]) continue;
					t_id = child[j][1];
					t_name = child[j][0];
					// === Replace with search()
					if (t_name.lastIndexOf(":") != -1) {
						t_folder = t_name.substr(0, t_name.lastIndexOf(":"));			
						t_name = t_name.substr(t_name.lastIndexOf(':')+1, t_name.length);
					} else {
						t_folder = th_folder;
					}
					if (!t_map[t_folder])
						t_map[t_folder] = new Array();
					if (!t_map[t_folder][t_id])
						t_map[t_folder][t_id] = t_name;
				}
				for (var list in t_map) {
					if ((list != th_folder) || (list == "CSC")) {
						out += "<fieldset>";
						out += "<legend class='t_hdr'><a class='test_hdr2' href='' onClick='return showHide(\"id_"+list+"\"); return false;'>"+list+"</a></legend>";
						out += "<div class='t_div' id='id_"+list+"' style='overflow: hidden;'>";				
					}
					out += "<table class='tests_table'>";
					folder = t_map[list];			
					for (var entry in folder) {
						// <td><input type=checkbox id='cb_"+entry+"'></td>
						out += "<tr></td><td><a class='add_to_list' href='' onClick='addToTestsShowList(\"Custom\",\""+entry+"\",\""+folder[entry]+"\" ,\""+scope+"\");return false;'>[+]</a>";
						out += "</a><a class='test_item' href='' id =\""+entry+"\"  onClick='Canvas=\""+entry+"\";Scope=\""+scope+"\";return updateBrowserPage(\""+entry+"\",false,3)'>"+folder[entry]+"</a></td></tr>";			 				
						if (scope=="CSC" ) { 
							addToTestsShowList("All CSC Tests", entry, folder[entry], scope);
						}
							
							
					}
					out += "</table>";
				
					if ((list != th_folder)|| (list == "CSC")) out += "</div></fieldset>";
					
				}
				
				out += "</div></fieldset>";

			}
			obj.innerHTML = out;
		}		
	}	
}	


// Load Available CSCs list for selected Run 
function loadCSCList()
{
	getCSCListDelay=20;
	var fullUrl = baseURL+CSCList+"?run="+RunName;
	// var r_link=document.getElementById("RunLink");
	// if (r_link) r_link.innerHTML = "Run Number: <a class='RLink' href=''>" + RunNumber + "</a>";
	// addlog("called loadCSCList for "+RunName, "debug");	
	var req=false;
	if (window.XMLHttpRequest) { 
		/*
		try {
	    		netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite");
	   	} catch (e) {
	    		alert("Permission UniversalBrowserRead denied.");
	   	}
		*/
	    req = new XMLHttpRequest();    
	   
	} else if (window.ActiveXObject) {    
		//req = new ActiveXObject("Microsoft.XMLDOM");
	    req = new ActiveXObject((navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) ? "Microsoft.XMLHTTP" : "Msxml2.XMLHTTP");
		// var req = new ActiveXObject("Microsoft.XMLHTTP");
	}
    req.open("GET",fullUrl,true); // true= asynch, false=wait until loaded    
	
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
			if (req.status==200) {	        
				var reply = req.responseText;
				// Need to strip malformed array string to satisfy IE7
				reply = reply.replace(/,]/g,"]");
				reply = reply.replace("var ","");
	        	window.eval(reply);
				showHWTable();				
				updateCSCMappings();
				selectSystemFolder(selFolder);
				getDQMReport();
				
				selectObject(RunName,false,2);
				// selectObject(id, false, 2);				
				// addlog(document.URL, "info");
				req=false;
	    	} else if (req.status==404) {
	    	}
						
		}
    }
  	req.send(null);
        if (RunName == "Online")
        {
          setTimeout('loadCSCList()', 20000);
        }
	return false;
}

function getCSCCounters()
{
	// getCSCListDelay=20;
	var fullUrl = baseURL+CSCCounters+"?run="+RunName;
	// var r_link=document.getElementById("RunLink");
	// if (r_link) r_link.innerHTML = "Run Number: <a class='RLink' href=''>" + RunNumber + "</a>";
	
	var req=false;
	if (window.XMLHttpRequest) { 
		/*
		try {
	    		netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite");
	   	} catch (e) {
	    		alert("Permission UniversalBrowserRead denied.");
	   	}
		*/
	    req = new XMLHttpRequest();    
	   
	} else if (window.ActiveXObject) {    
		//req = new ActiveXObject("Microsoft.XMLDOM");
	    req = new ActiveXObject((navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) ? "Microsoft.XMLHTTP" : "Msxml2.XMLHTTP");
		// var req = new ActiveXObject("Microsoft.XMLHTTP");
	}
    req.open("GET",fullUrl,true); // true= asynch, false=wait until loaded    
	
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
			if (req.status==200) {	        
				var reply = req.responseText;
				// Need to strip malformed array string to satisfy IE7
				reply = reply.replace(/,]/g,"]");
				reply = reply.replace("var ","");
	        	window.eval(reply);
				showCSCCounters();
				req=false;
	    	} else if (req.status==404) {
	    	}
						
		}
    }
	req.send(null);	
	if (RunName == "Online")
        {
	  setTimeout('getCSCCounters()', 20000);
	}
	return false;
}


function findTestPlotInfo(id)
{
	var testPlot = "";
	// addlog(id, "debug");
	if (TESTS_MAP && TESTS_MAP.bindings.length) {
		for (var i = 0; i < TESTS_MAP.bindings.length; i++) {
			map_entry = TESTS_MAP.bindings[i];
			if (map_entry && map_entry.testID && map_entry.testPlot
				&& (map_entry.testID == id)) { 
					// addlog("Found " + id, "debug");
					return map_entry;
				}
		}
	}
		
	return false; 	
}


function crateID(tag)
{
	var pos = tag.search("crate");
	if ( pos >=0) return parseInt(tag.substr(pos+5,tag.length));
	return 0;
}

function slotID(tag)
{
	var pos = tag.search("slot");
	if ( pos>=0 ) return parseInt(tag.substr(pos+4,tag.length));
	return 0;
}

function findHWId(id)
{
	var m_list = CSCMAP;
	if (m_list.length>0) {
		for (var i=0; i<m_list.length; i++) {
			if (m_list[i][2] == id )
			   return "CSC_"+addPadding(crateID(m_list[i][0]),3,'0')+"_"+addPadding(slotID(m_list[i][1]),2,'0');		
		}	
	}
	return "";
}

function getFolderName(id, scope) {
	if (scope == "EMU") return "EMU";
	if (scope == "DDU" && (id.search("DDU_") >=0)) return id;
	if (scope == "CSC" ) return findHWId(id);
	return id;
}


function findReportEntry(report, id)
{
	
	for (var i = 0; i < report.length; i++) {
		if (report[i].objID  == id)
			return report[i];
	}
	return false;
}

function setTestsStatus(id)
{
	loadTestsList (TREE_ITEMS, "tests_div");
	var out = "<table class='dqm_report'><tr><th class='repScope' colspan=3><b>Status for " + id + "</b></th></tr>";
	if (DQM_REPORT && DQM_REPORT.report.length) {
		var repentry = findReportEntry(DQM_REPORT.report, id);
		if (repentry) {	
			
			if (repentry.list && repentry.list.length) {
				err_list = repentry.list;
				
				for (var j=0; j< err_list.length; j++) {
					var entry = err_list[j];
					if (entry) {
						
						//out += "<tr><td></td><td>" + entry.descr + "</td><td>"+entry.severity+"</td></tr>";
						
						var sev_idx = parseInt(entry.severity);
						var sev_name = DQM_SEVERITY[sev_idx].name;
						var sev_str = "";
						if ( sev_idx > 0) {
							sev_str = "<span class='SEVERITY_"+sev_name+"'>" + sev_name + "</span>";
						} 
												
						var descr_str = entry.descr;
						if (entry.testID != "") {
							var testInfo = findTestPlotInfo(entry.testID);
							if (testInfo) {
								var testFolder = getFolderName(repentry.objID, testInfo.testScope);//getFolder()
								var testPlot = testInfo.testPlot + ".png";
								var t_obj = document.getElementById(testPlot);
								if (t_obj) {
									t_obj.style.background = DQM_SEVERITY[sev_idx].color;
								}
								// descr_str = entry.descr + " " +testPlot;
								descr_str = "<a href='' onClick='Folder=\""+testFolder+"\";Scope=\""+testInfo.testScope+"\";Canvas=\""+testPlot+"\";return updateBrowserPage(\""+testPlot+"\",false,3)'>"+add_show_icon() + entry.descr + "</a> ";
							}
							
						}
						out += "<tr><td>" + sev_str+ "</td><td>"+ descr_str + "</td></tr>";
					}
				}
			}							
		}
	}
	out += "</table>";
	rep_div = document.getElementById("report_entry_div");
	if (rep_div) rep_div.innerHTML = out;						

}

function setEntryStatus(objname, severity)
{
	if (objname) {
		
		if (objname.search("DDU") >= 0) {
			idx = getDDUindex(objname)// DDUs.push(entry);
			id = addPadding(idx,2,'0');
			dduID = "csc_DDU"+id;
			m_obj = document.getElementById("cscDDU"+id);
			if (m_obj) {
				// addlog(objname + " " + severity, "debug");
				m_obj.style.background = DQM_SEVERITY[severity].color;			
			}			
		}
		if (objname.search("ME") >= 0) {			
			m_obj = document.getElementById(objname); 
			if (m_obj) {
				// addlog(objname + " " + severity, "debug");
				m_obj.style.background = DQM_SEVERITY[severity].color;			
			}
		}
	}
}



function add_show_icon()
{
	return "<span class='show_icon'>[?]</span> ";
}


function loadDQMReport(id)
{
				
	obj = document.getElementById(id);
	if (obj) {
		out = "";
		if (DQM_REPORT) {
			/// if (reportWindow && !reportWindow.closed) openReportInWindow();
			// var fullUrl = ResultsFolder+RunNumber+".plots/" + TextReport;	
			// var out = "<b>DQM Summary Report for Run: <a href='" + fullUrl + "'>" + DQM_REPORT.run + "</a><br> (generated on "+DQM_REPORT.genDate+")</b>";
				// <a href='' onClick='openReportInWindow();return false;'>[Open]</a></h5>";
			out += printReportLegend();
			out += "<table class='dqm_report'>";
		
			// addlog("DQM report #entries: " + DQM_REPORT.report.length, "info");
			report = DQM_REPORT.report;
			if (report && report.length) {
				for (var i = 0; i < report.length; i++) {
					if (report[i]) {
						var obj_sev = 0;
						out += "<tr><th class='repScope' colspan=3><b>" + report[i].name + "</b></th></tr>";
						if (report[i].list && report[i].list.length) {
							err_list = report[i].list;
							
							for (var j=0; j< err_list.length; j++) {
								var entry = err_list[j];
								if (entry) {
									
									//out += "<tr><td></td><td>" + entry.descr + "</td><td>"+entry.severity+"</td></tr>";
									
									var sev_idx = parseInt(entry.severity);
									var sev_name = DQM_SEVERITY[sev_idx].name;
									var sev_str = "";
									if ( sev_idx > 0) {
										sev_str = "<span class='SEVERITY_"+sev_name+"'>" + sev_name + "</span>";
									} 
									
									if (sev_idx > obj_sev) obj_sev = sev_idx;
									var descr_str = entry.descr;
									if (entry.testID != "") {
										var testInfo = findTestPlotInfo(entry.testID);
										if (testInfo) {
											var testFolder = getFolderName(report[i].objID, testInfo.testScope);//getFolder()
											var testPlot = testInfo.testPlot + ".png";
											// descr_str = entry.descr + " " +testPlot;
											descr_str = "<a href='' onClick='Folder=\""+testFolder+"\";Scope=\""+testInfo.testScope+"\";Canvas=\""+testPlot+"\";return updateBrowserPage(\""+testPlot+"\",false,3)'>"+add_show_icon()+ entry.descr + "</a> ";
										}
										
									}
									out += "<tr><td>" + sev_str+ "</td><td>"+ descr_str + "</td></tr>";
								}
							}
						}	
						out += "</tr>";
						setEntryStatus(report[i].objID, obj_sev);
					// addlog(DQM_REPORT.report[i].objID, "info");
					// setEntryStatus(DQM_REPORT.report[i]);
					}
				}
			} else {
				out = "DQM Report file for Run:" + RunName +" is empty";
				addlog(out, "warn");
			}
			out += "</table>";
		
		} else {
			out = "DQM Report file for Run:" + RunName +" not found";
			addlog(out, "warn");
		}
		obj.innerHTML=out;
		// DQMReport = out;
	}
}

function loadRunsList(r_list) 
{	
	
	// out += "<div><table class='runs_table'>";
	out = "<table class='runs_table'>";
	out += "<th>Run</th><th>Analyzed on</th>";
	out += "<tr><td><a href='' id='Online' onClick='RunName=\"Online\";getTestsList();getCSCCounters();loadCSCList(\"Online\");return false;'>Online</a></td><td></td></tr>";
	if (r_list) {
		// addlog("runs", "info");
		for (var i = 0; i< r_list.length; i++) {
			child = [];		
			child=r_list[i];
			if (!child) continue;
			// remove ref.root from list
			if (child[0].search(/ref.root/g) != -1) continue;
			run_descr = child[0].replace(/.root/g,'');
			run_num = child[0].substr(0, child[0].search(/.root/g));
			run_time = child[0].substr(child[0].search(/\(/g),child[0].search(/\)/g));
			// if (i==0) RunNumber = run_num;
			// addlog(run_descr, "info");
			out += "<tr><td><a href='' id='"+run_num+"' onClick='RunName=\""+run_num+"\";getTestsList();getCSCCounters();loadCSCList(\""+run_num+"\");return false;'>"+run_num+"</a></td><td>"+run_time+"</td></tr>";
			
		}
		
	} 
	
	out += "</table>";
	obj = document.getElementById("runs_list");
	if (obj) obj.innerHTML = out;
	
}	


function getRunsList()
{
	var fullUrl = baseURL+ RunsList;
	
	
	var req=false;
	if (window.XMLHttpRequest) { 
		/*
		try {
	    		netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite");
	   	} catch (e) {
	    		alert("Permission UniversalBrowserRead denied.");
	   	}
		*/
	    req = new XMLHttpRequest();    
	   
	} else if (window.ActiveXObject) {    
		//req = new ActiveXObject("Microsoft.XMLDOM");
	    req = new ActiveXObject((navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) ? "Microsoft.XMLHTTP" : "Msxml2.XMLHTTP");
		// var req = new ActiveXObject("Microsoft.XMLHTTP");
	}
    req.open("GET",fullUrl,true); // true= asynch, false=wait until loaded    
	
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
			if (req.status==200) {	        
				var reply = req.responseText;
				// Need to strip malformed array string to satisfy IE7
				reply = reply.replace(/,]/g,"]");
				reply = reply.replace("var ","");
	        	window.eval(reply);
				loadRunsList(RUNS);
				selectObject(RunName,false,2);
				// addlog(reply, 'debug');
				// updateBrowserPage(Canvas,false,3);				
				// updateBrowserPage(id,false,2);
	    	} else if (req.status==404) {				
				addlog("Can not load " + fullUrl, 'error');
				RUNS=false;
				loadRunsList(RUNS);
				selectObject(RunName,false,2);
	    	}
						
		}
    }
	req.send(null);	
	setTimeout('getRunsList()', 60000);
	return false;
}

function getDQMReport()
{
	var fullUrl = baseURL + JSONReport+"?run="+RunName;
	
	
	var req=false;
	if (window.XMLHttpRequest) { 
		/*
		try {
	    		netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead UniversalBrowserWrite");
	   	} catch (e) {
	    		alert("Permission UniversalBrowserRead denied.");
	   	}
		*/
	    req = new XMLHttpRequest();    
	   
	} else if (window.ActiveXObject) {    
		//req = new ActiveXObject("Microsoft.XMLDOM");
	    req = new ActiveXObject((navigator.userAgent.toLowerCase().indexOf('msie 5') != -1) ? "Microsoft.XMLHTTP" : "Msxml2.XMLHTTP");
		// var req = new ActiveXObject("Microsoft.XMLHTTP");
	}
    req.open("GET",fullUrl,true); // true= asynch, false=wait until loaded    
	
    req.onreadystatechange = function() {
        if (req.readyState == 4) {
			if (req.status==200) {
				DQM_REPORT = false;
				
				var reply = req.responseText;
				// Need to strip malformed array string to satisfy IE7
				reply = reply.replace(/,]/g,"]");
				reply = reply.replace("var ","");
				window.eval(reply);				
				loadDQMReport("report_div");
				
				
	    	} else if (req.status==404) {
				DQM_REPORT = false;
				addlog("Can not load " + fullUrl, 'warn');
				// loadTextReport("report_div");
				loadDQMReport("report_div");
	    	}
						
		}
    }
	req.send(null);	
	// setTimeout('getDQMReport()', 20000);
	return false;
}

function getVMECrateName(crate)
{
	if (VMEMAP && VMEMAP.length) {
		for (var i=0; i<VMEMAP.length; i++) {
			if (crate == "crate"+VMEMAP[i][1]) {
				return VMEMAP[i][0];
			}			
		}
	}
}

function showCSCCounters()  
{
	cntrs=CSC_COUNTERS;
	csc_map = CSCMAP;
	var obj=document.getElementById("csccounters_div");
	if (obj) {
		var out="<table>";
			if (cntrs && cntrs.length >0) {
			cscs = cntrs[0];								
			var crate=0;
			var slot=0;
			cnt_bad_alct=0;
			cnt_bad_clct=0;
			cnt_bad_cfeb=0;
			cnt_bad_events=0;
			for (var i=1; i<cscs.length; i++) {
				if (!cscs[i]) continue;
				var csc = cscs[i][0];	
				stats = cscs[i][1];
				n_crate = parseFloat(csc.substring(4,7));
				if (n_crate != crate ) { 
					crate_str=getVMECrateName("crate"+n_crate) + ": crate"+n_crate;
					out+="</tr><tr><td class='node_info'><b>"+crate_str+"</b></td>";
					crate=n_crate;
				}
				slot = parseFloat(csc.substring(8,10));
				cscid = "";
				for (var k=0; k<csc_map.length; k++) {
						if (!csc_map[k]) continue;
						map_entry = csc_map[k];
						if ((map_entry[0] == "crate"+crate) && (map_entry[1] == "slot"+slot)) {cscid = map_entry[2];}
				}
				
				stats_out="";
				alct=0;
				clct=0;
				cfeb=0;
				bad=0;
				dmb=0;
				
				
				
				if (stats && stats.length)
				{
					for (var j=0; j<stats.length; j++) {
						// stats_out+= stats[j][1]+",";
						tag = stats[j][0];
						if (tag=='ALCT') alct=parseInt(stats[j][1]);
						if (tag=='CLCT') clct=parseInt(stats[j][1]);
						if (tag=='CFEB') cfeb=parseInt(stats[j][1]);
						if (tag=='BAD') bad=parseInt(stats[j][1]);
						if (tag=='DMB') dmb=parseFloat(stats[j][1]);
					}
				}
				if (dmb) {
					bcolor='white';
					color="black";
					badclr='#FFD0D0';
					if ((100*alct/(dmb-bad))<30) { color="red"; cnt_bad_alct++;}
					stats_out+="A:<font color='"+color+"'>"+(100*(alct/(dmb-bad))).toFixed(1)+"</font>;";
					color="black";
					if ((100*clct/(dmb-bad))<30) { color="red"; cnt_bad_clct++;}
					stats_out+="T:<font color='"+color+"'>"+(100*(clct/(dmb-bad))).toFixed(1)+"</font>;";
					color="black";
					if ((100*cfeb/(dmb-bad))<30) { color="red"; cnt_bad_cfeb++;}
					stats_out+="C:<font color='"+color+"'>"+(100*(cfeb/(dmb-bad))).toFixed(1)+"</font>";// ;Bad:"+bad;
				
					color="black";
					if ((100*bad/dmb)>10) { color="red"; bcolor=badclr; cnt_bad_events++;}
					out += "<td style='background-color: "+bcolor+"'><b>(dmb"+slot+") "+cscid+"</b><br>#E:"+dmb+";"					
					out +=" #B:<font color='"+color+"'>"+bad+"("+(100*(bad/(dmb))).toFixed(1)+")</font><br>"+stats_out+"</td>";
				}
				// slots = crates[i][1];			
				out += "";
				// addlog(csc, "debug");
			}		
		}		
		out+= "</table>";	
		out= "<table><tr><td class='node_info'>Summary (#CSCs with failed efficiencies)</td><td class='node_info'>Bad events: <b>"+cnt_bad_events+"</b></td><td class='node_info'>ALCT: <b>"+cnt_bad_alct+"</b></td><td  class='node_info'>TMB/CLCT: <b>"+cnt_bad_clct+"</b></td><td  class='node_info'>CFEB: <b>"+cnt_bad_cfeb+"</b></td></tr></table>"+out;
		out+= "<table><tr><td class='node_info'>Legend: #E - #of Events; #B - #of Bad Events; A - ALCT; T - TMB/CLCT; C - CFEB Efficiencies in %</td></tr></table>";
		obj.innerHTML=out;
		return;
		try {
						title="CSC Counters Stats";
						var generator=window.open('','counters','height='+800+',width='+1000+',resizable=no');						
						if (window.focus) {generator.focus()} 
						generator.resizeTo(1000, 800);
						generator.document.write('<html><head><title>'+title+'</title>');
						generator.document.write("<style>body {color: #000000; background-color: #9090FF;margin: 2px;font-family:Arial;	overflow: auto;}"+
						"span.winTitle {	margin: 0;font-size: 12px;font-weight: bold;text-decoration: none;color: #000000;}"+
						"fieldset {background-color: #ddd;	border-style: solid;border-width: 1px;border-color: black;margin: 2px;padding: 2px;}"+
						"legend {border-style: solid;border-width: 1px;background-color:  #C0C0FF;}td.node {background-color: white; text-align: left; font-size: 8pt;"+
						"padding: 0px;}</style>");
						generator.document.write('</head><body>');
						generator.document.write("<fieldset><legend><span class='winTitle'>"+title+"</span></legend>");
						generator.document.write(out);
						generator.document.write("</fieldset>");
						// generator.document.write('<p><a href="javascript:self.close()">Close</a> the popup.</p>');
						generator.document.write('</body></html>');
						generator.document.close();
					  } 
					  catch (exc){
					}
	}
}

function updateSysStatus() 
{
	var obj=document.getElementById("sysstatus_div");
	if (obj) {
		getNodesListDelay-=2;
		if (getNodesListDelay<0) getNodesListDelay=0;
		getCSCListDelay-=2;
		if (getCSCListDelay<0) getCSCListDelay=0;
		var out="<table><tr>";
		
		out+= "<td><b>Total:</b></td><td class='td_status'> #DDUs: <b>"+ numDDUs+"</b></td><td class='td_status'> #CSCs: <b>"+numCSCs+"</b></td>";
		out+= "<td class='td_status'>DAQ Evts: <b>"+totalDAQevents+"</b></td><td class='td_status'>DQM Evts: <b>"+totalDQMevents+"</b></td>"
		out+= "<td class='td_status'>CSC blocks: <b>"+totalCSCblocks+"</b></td><td class='td_status'>DQM Rate: <b>"+totalDQMrate+"</b></td>";
		out+= "<td class='td_status'>CSC Rate: <b>"+totalCSCrate+"</b></td>";
		out+= "<td class='td_status'>Upd Nodes in <b>"+getNodesListDelay+"</b>s</td><td class='td_status'>Upd CSC List in <b>"+getCSCListDelay+"</b>s</td></tr></table>";
		
		obj.innerHTML=out;
	}
	setTimeout('updateSysStatus()', 2000);
}

function updateCSCMappings()
{
	c_list = CSC_LIST;
	showCSCTable("csctable_div");
	showDDUTable("ddutable_div");
	//resetCSCTable('csc_table');
	
	numCSCs=0;
	numDDUs=0;
	if (c_list.length > 0) {
		c_tree = c_list[0];
		for ( var j=1; j<c_tree.length; j++) {
			key = c_tree[j][0];
			entries = c_tree[j][1];
			if (entries.length >0) {
				for (k=0; k<entries.length; k++) {
					enableCSCTableEntry(key, entries[k]);
				}
			}
		}		
	}
	// updateSysStatus();
	// selectFolder(Folder);
}

function getDDUindex(id)
{
	ddu_map = DDUMAP;
	if (ddu_map) {
		for (i=0; i< ddu_map.length; i++) {
			if (ddu_map[i] && ddu_map[i].length) {
				if (id == ddu_map[i][0]) return ddu_map[i][1];
			}
		}
	} else {
		return DDUs.push(id);
	}
}

function enableCSCTableEntry(entry_key, entry)
{
	obj_sel = selectedObjectList[4];
	var r_link=document.getElementById("RunLink");
	if (r_link) r_link.innerHTML = "<a class='RLink' href=''>Run: " + RunNumber + "</a>";
	if (entry_key.search("EMU") >= 0) {
		obj = document.getElementById("cscCommon");
		if (obj) {
			obj.style.background = 'lightgreen';			
			val = obj.innerHTML;
			emuID = "csc_" + entry;
			// emuLink="<a href='#' id='" + emuID+ "' onClick='Folder=\""+entry+"\"; return loadFrame(\""+emuID+"\",false, 4)'>Common</a>";
			emuLink="<a href='' id='" + emuID+ "' onClick='Folder=\""+entry+"\"; selectSystemFolder(\""+entry+"\"); setTestsStatus(\""+entry+"\");return loadPlot();'>EMU Summary</a>";
			obj.innerHTML = emuLink;
			if (obj_sel && (obj_sel.id.search(emuID) >= 0 )) {
				Folder = entry;
				selectSystemFolder(entry);
				// select(emuID, false, 4);
				// addlog(obj_sel.id, "info");				
			}
		}
	}
	if (entry_key.search("DDU") >= 0) {
		idx = getDDUindex(entry)// DDUs.push(entry);
		id = addPadding(idx,2,'0');
		dduID = "csc_"+entry;
		obj = document.getElementById("cscDDU"+id);
		if (obj) {
			numDDUs++;
			obj.style.background = 'lightgreen';
			val = obj.innerHTML;
			// emuLink="<a href='#' id='" + dduID+ "' onClick='Folder=\""+entry+"\"; return loadFrame(\""+dduID+"\",false, 4)'>"+idx+"</a>";
			dduLink="<a href='' id='" + dduID+ "' onClick='Folder=\""+entry+"\"; selectSystemFolder(\""+entry+"\"); showConnectedCSCs(\""+idx+"\"); setTestsStatus(\""+entry+"\");return loadPlot();'>"+idx+"</a>";
			obj.innerHTML = dduLink;
			if (obj_sel && (obj_sel.id == dduID)) {
				Folder = entry;
				selectSystemFolder(entry);
				// addlog("Found " + obj_sel.id + ": "+entry_key+"/"+entry, "debug");
				// select(dduID, false, 4);
				// addlog(obj_sel.id, "info");				
			}
		}
	}
	else if (entry_key.search("crate") >=0) {
		cscName = findCSCFromMap(entry_key, entry);
		obj = document.getElementById(cscName); 
		if (obj) {
			numCSCs++;
			obj.style.background = 'lightgreen';
			val = obj.innerHTML;
			// csc = entry_key+"/"+entry;
			var csc = makeCSCid(entry_key, entry);
			cscID = "csc_" + csc;
			// csclink="<a href='#' id='" + cscID+ "' onClick='Folder=\""+csc+"\"; return loadFrame(\""+cscID+"\",false, 4)'>"+val+"</a>";
			csclink="<a href='' id='" + cscID+ "' onClick='Folder=\""+csc+"\"; selectSystemFolder(\""+csc+"\"); findLinkedDDU(\""+cscName+"\"); setTestsStatus(\""+cscName+"\");return loadPlot();'>"+val+"</a>";
			obj.innerHTML = csclink;
			addToFoldersShowList("All CSCs", csc, cscName);
			if (obj_sel && (obj_sel.id == cscID)) {
				Folder = csc;
				selectSystemFolder(csc);
				// addlog("Found " + obj_sel.id + ": "+entry_key+"/"+entry, "debug");
				// selectFolder(Folder);
				// select(cscID, false, 4);
				// addlog(obj_sel.id, "info");				
			}
			
		}	
	} 
	//addlog(selected_list[4], "info");
}

function findCSCFromMap(crate, slot, m_list)
{
	
	m_list = CSCMAP;
	if (m_list.length>0) {
		for (var i=0; i<m_list.length; i++) {
			if ( (m_list[i][0] == crate) && 
				(m_list[i][1] == slot) )
			   return m_list[i][2];		
		}	
	}
	return "";
}


function selectNode(id)
{
	node = "node_"+id;
	selectObject(node, false, 6);	
	selNode = id;
	return false;
}

function selectSystemFolder(id)
{
	isFolderValid=true;	
	hw_id = "hw_"+id;
	csc_id = "csc_"+id;
	selectObject(hw_id, false, 1);
	selectObject(csc_id, false, 4);
	selFolder=id;
	// addlog(selFolder, "debug");
	return false; 
}

function selectTest(id, b_select)
{
	isFolderValid=true;	
	
	selectObject(id, b_select, 3);
	// addlog(selected_list[idx].id, "debug");
	// loadPlot();
	return false; 
}

function updateBrowserPage(id, f_select, idx)
{
	isFolderValid=true;		
	selectObject(id, f_select, idx);
	// addlog(selected_list[idx].id, "debug");
	loadPlot();
	return false; 
}


function decImageHeight()
{	
	imgHeight = imgHeight-imgSizeStep;
	if (imgHeight<minImageHeight) imgHeight=minImageHeight;
	obj = document.getElementById("imageHeight");
	if (obj) obj.value = imgHeight;
			
			
	// loadPlot();
}

function incImageHeight()
{
	imgHeight = imgHeight+imgSizeStep;
	if (imgHeight>maxImageHeight) imgHeight = maxImageHeight;	
	obj = document.getElementById("imageHeight");
	if (obj) obj.value = imgHeight;
	
	
	// loadPlot();
}

function decImageWidth()
{	
			
	imgWidth = imgWidth-imgSizeStep;
	if (imgWidth<minImageWidth) imgWidth = minImageWidth;	
	obj = document.getElementById("imageWidth");
	if (obj) obj.value = imgWidth;
			
	//loadPlot();
}

function incImageWidth()
{
	
	imgWidth = imgWidth+imgSizeStep;
	if (imgWidth>maxImageWidth) imgWidth = maxImageWidth;	
	obj = document.getElementById("imageWidth");
	if (obj) obj.value = imgWidth;
	
	//loadPlot();
}

function selectPlotMode()
{
	var obj = document.getElementById("openExternal");
	if (obj) {
		if (obj.checked) {
			fOpenExternal=true;
		} else {
			fOpenExternal=false;
		}
	}
}

function selectShowReferenceMode()
{
	var obj = document.getElementById("showReference");
	if (obj) {
		if (obj.checked) {
			fShowReference=true;
		} else {
			fShowReference=false;
		}
	}
}

function selectUpdateMode()
{
	var obj = document.getElementById("autoUpdateMode");
	if (obj) {
		if (obj.checked) {
			fAutoUpdatePlot=true;
			updatePlots();
		} else {
			fAutoUpdatePlot=false;
		}
	}
}

function selectObject (id, f_deselect, idx) {
	var obj = get_element(id);
	if (obj) {
		
		if(!f_deselect) {
			var o_olditem = selectedObjectList[idx];
			selectedObjectList[idx] = obj;
			if (o_olditem) selectObject(o_olditem.id, true, idx);
			
		}
		if (obj.style) {
			obj.style.fontWeight = f_deselect ? 'normal' : 'bold';
			obj.style.color = f_deselect ? '#000000' : '#0000ff';
		}
	} 
}

var timerID = 0;
var tStart  = null;

var showList = new Array();
var showIdx = 0;
var folderIdx = 0;
var foldersSList = "";
var updateDelay = 5;

function setSelectedList() {
	var selObj = document.getElementById("showlist_selection");
	if (selObj) {
		var selIdx = selObj.selectedIndex;
		selList = selObj.options[selIdx].value;
		showSlideShowList(selList);
		showList = testsShowLists[selList];
	}
}

function setSelectedFoldersList() {
	var selObj = document.getElementById("folders_selection");
	if (selObj) {
		var selIdx = selObj.selectedIndex;
		selList = selObj.options[selIdx].value;
		foldersSListIdx = selIdx;
		foldersSList = selList;
		// addlog(selList, "info");
		// folderList = foldersShowLists[selList];
	}
}




function showNextSlide()
{
	showIdx++;
	showSlide();
}

function showPrevSlide()
{
	
	
	if (showIdx==0) showIdx=showList.length;
	showIdx--;
	showSlide();
}
function showSlide()
{
   if (showIdx >= showList.length || showIdx<0) { showIdx = 0;}
   if (showList[showIdx]) { 
	Canvas = showList[showIdx][0];
	Scope = showList[showIdx][2];
	}
   
   obj = document.getElementById("currentTest");
   // addlog(Canvas, "debug");
   loadPlot();
   selectTest(Canvas, false);
   selectSystemFolder(Folder);
   //loadFrame(Canvas, false, 3);
   selectObject("ssid_"+showIdx, false, 5);
   if (obj) obj.innerHTML = Canvas;
   
}

function updateSlideShowTimer() {
   if(timerID) {
      clearTimeout(timerID);
      clockID  = 0;
   }

   if(!tStart)
      tStart   = new Date();

   var   tDate = new Date();
   var   tDiff = tDate.getTime() - tStart.getTime();

   
   tDate.setTime(tDiff);
/*
   document.theTimer.theTime.value = "" 
                                   + tDate.getMinutes() + ":" 
                                   + tDate.getSeconds();
   */
   
   
   showSlide();
   
   if (foldersSListIdx > 0) 
   {
	 if (loopFoldersFirst) 
	 {
		fList = foldersShowLists[foldersSList];
		if (folderIdx >= fList.length-1) 
		{
			folderIdx = 0;
			showIdx++;
		 } else {
			folderIdx++;
		 }
		 Folder =  fList[folderIdx][0];
		 
	 };
	 // addlog(Folder,"debug");
   } else {
	showIdx++;
   }
   timerID = setTimeout("updateSlideShowTimer()", updateDelay*1000);
}

function startSlideShow() {
   tStart   = new Date();
   obj = document.getElementById("updateInterval");
   if (obj) {
	val = parseInt(obj.value);
	if (!isNaN(val) && val <=30) updateDelay = val;
   }
   	
	
   showSlideShowList();
   if (foldersShowLists[foldersSList][0]) {
		Folder = foldersShowLists[foldersSList][0][0];
		folderIdx = 0;
	}
   
   
   timerID  = setTimeout("updateSlideShowTimer()", updateDelay*1000);
}

function stopSlideShow() {
   if(timerID) {
      clearTimeout(timerID);
      timerID  = 0;
   }
   tStart = null;
}

function resetSlideShow() {
   tStart = null;
   showIdx=0;
   folderIdx = 0;

   // document.theTimer.theTime.value = "00:00";
}


function initSlideShowList()
{
	document.write('<label>Tests:</label>');
	document.write('<select id="showlist_selection" onChange="setSelectedList();">');
	for (var s_list in testsShowLists) {
		document.write("<option value='"+s_list+"'>"+s_list);
	}
	// document.write("<option value='m1'>Custom");
	document.write('</select>');
	setSelectedList();
	document.write('<label>Folders:</label>');
	document.write('<select id="folders_selection" onChange="setSelectedFoldersList();">');
	for (var s_list in foldersShowLists) {
		document.write("<option value='"+s_list+"'>"+s_list);
		
	}
	// document.write("<option value='m1'>Custom");
	document.write('</select>');
	setSelectedFoldersList();
}

function showSlideShowList(list)
{
	s_list = document.getElementById("slideshow_list");
	if (s_list && testsShowLists && testsShowLists[list]) {
		s_list.innerHTML = "";
		s = "";
		s += '<table width=100%>';
		if (list == "Custom") {
			s += "<tr><td><input type=button name=\"clear\" value=\"Clear\" onclick=\"clearShowList('Custom');\"></td></tr>";
		}		
		sList = testsShowLists[list];
		ctrlStr = "";
		for (var i=0; i< sList.length; i++) {
			if (list == "Custom") {
				ctrlStr = "<a class='remove_from_list' href='' onClick='removeFromTestsShowList(\"Custom\",\""+i+"\");'>[x]</a>"
			}
			s += '<tr><td id="ssid_'+i+'">'+ctrlStr+sList[i][1]+'</td></tr>';
		}
		s += '</table>';
		s_list.innerHTML = s;
		// select("ssid_0", false, 5);
	}
}

function removeFromTestsShowList(list, idx)
{
	if (testsShowLists && testsShowLists[list]) {
		testsShowLists[list].splice(idx,1);
		showSlideShowList(list);
	}
}

function addToTestsShowList(list, testID, testName, scope)
{
	var inList = false;
	if (testsShowLists) {
		var entry = new Array();
		entry[0]=testID;
		entry[1]=testName;
		entry[2]=scope;
		if (!testsShowLists[list]) testsShowLists[list] = new Array();
		sList = testsShowLists[list];
		for (var i=0; i<sList.length; i++) {			
			if (sList[i][0] == testID) inList = true;
		}
		if (!inList) sList.push(entry);
	}
	if (list == "Custom") showSlideShowList(list);
}

function addToFoldersShowList(list, folderID, folderName)
{
	var inList = false;
	if (foldersShowLists) {
		var entry = new Array();
		entry[0]=folderID;
		entry[1]=folderName;
		
		if (!foldersShowLists[list]) foldersShowLists[list] = new Array();
		sList = foldersShowLists[list];
		for (var i=0; i<sList.length; i++) {			
			if (sList[i][0] == folderID) inList = true;
		}
		if (!inList) sList.push(entry);
	}
//	if (list == "Custom") showSlideShowList(list);
}

function clearShowList(id, list)
{
	if (id == "Tests") {
		if (testsShowLists && testsShowLists[list]) { 
			testsShowLists[list].length = 0;
			showSlideShowList(list);
		}
	} else if (id == "Folders") {
		if (foldersShowLists && foldersShowLists[list]) { 
			foldersShowLists[list].length = 0;
			// showSlideShowList(list);
		}
	}
	
}



function setSelectedTab(obj)
{
   o_selected = get_element("selected");
   if (o_selected) {
	o_selected.id = '';
   }
   obj.id = "selected";
   if (obj.title == "csc_view") {
	div_obj = get_element("csctable_div");
	div_obj.style.display = "";
	div_obj = get_element("hwtable_div");
	div_obj.style.display = "none";
	div_obj = get_element("ddutable_div");
	div_obj.style.display = "none";
	div_obj = get_element("report_div");
	div_obj.style.display = "none";
	div_obj = get_element("csccounters_div");
	div_obj.style.display = "none";
   }
   else if (obj.title == "hw_view") {
	div_obj = get_element("csctable_div");
	div_obj.style.display = "none";
	div_obj = get_element("hwtable_div");
	div_obj.style.display = "";
	div_obj = get_element("ddutable_div");
	div_obj.style.display = "none";
	div_obj = get_element("report_div");
	div_obj.style.display = "none";
	div_obj = get_element("csccounters_div");
	div_obj.style.display = "none";
   }
   else if (obj.title == "ddu_view") {
	div_obj = get_element("csctable_div");
	div_obj.style.display = "none";
	div_obj = get_element("hwtable_div");
	div_obj.style.display = "none";
	div_obj = get_element("ddutable_div");
	div_obj.style.display = "";
	div_obj = get_element("report_div");
	div_obj.style.display = "none";
	div_obj = get_element("csccounters_div");
	div_obj.style.display = "none";
   }
   else if (obj.title == "report_view") {
	div_obj = get_element("csctable_div");
	div_obj.style.display = "none";
	div_obj = get_element("hwtable_div");
	div_obj.style.display = "none";
	div_obj = get_element("ddutable_div");
	div_obj.style.display = "none";
	div_obj = get_element("report_div");
	div_obj.style.display = "";
	div_obj = get_element("csccounters_div");
	div_obj.style.display = "none";
   }
   else if (obj.title == "csccounters_view") {
	div_obj = get_element("csctable_div");
	div_obj.style.display = "none";
	div_obj = get_element("hwtable_div");
	div_obj.style.display = "none";
	div_obj = get_element("ddutable_div");
	div_obj.style.display = "none";
	div_obj = get_element("report_div");
	div_obj.style.display = "none";
	div_obj = get_element("csccounters_div");
	div_obj.style.display = "";
   }
   o_selected = obj;
   return false;
}

function setSelectedRunsTab(obj)
{
   o_selected = get_element("selected_runs");
   if (o_selected) {
	o_selected.id = '';
   }
   obj.id = "selected_runs";
   if (obj.title == "local") {
	div_obj = get_element("local_runs");
	div_obj.style.display = "";
	div_obj = get_element("global_runs");
	div_obj.style.display = "none";
	div_obj = get_element("online_runs");
	div_obj.style.display = "none";
   }
   else if (obj.title == "global") {
	div_obj = get_element("local_runs");
	div_obj.style.display = "none";
	div_obj = get_element("global_runs");
	div_obj.style.display = "";
	div_obj = get_element("online_runs");
	div_obj.style.display = "none";
   }else if (obj.title == "online") {
	div_obj = get_element("local_runs");
	div_obj.style.display = "none";
	div_obj = get_element("global_runs");
	div_obj.style.display = "none";
	div_obj = get_element("online_runs");
	div_obj.style.display = "";
   }
   o_selected = obj;
   return false;
}

get_element = document.all ?
	function (s_id) { return document.all[s_id] } :
	function (s_id) { return document.getElementById(s_id) };

</script>
</head>
<body>

<script type="text/javascript">
	if (navigator.userAgent.toLowerCase().indexOf('msie') != -1) isIE=true;
	baseURL=document.URL;
	if (document.URL.lastIndexOf('/') != document.URL.length-1) baseURL+="/";
	document.write('<script src="', baseURL+CSCMap, '" type="text/javascript"><\/script>');
	// document.write('<script src="', baseURL+RunsList, '" type="text/javascript"><\/script>');
	document.write('<script src="', baseURL+TestsList, '" type="text/javascript"><\/script>');
	document.write('<script src="', baseURL+DDUMap, '" type="text/javascript"><\/script>');
	document.write('<script src="', baseURL+VMEMap, '" type="text/javascript"><\/script>');
	document.write('<script src="', baseURL+TestsMap, '" type="text/javascript"><\/script>');
	
//-->
</script>

<table  class='page_layout' style='border: 0px black solid;'>
<tr style='border: 0px black solid;'><td style='border: 0px black solid;'>
	
	
	<fieldset id="DQMControl">
		<legend>
			<a class='winTitle' href='#' onClick='showHide("dqm_control");'>DQM Control</a>
		</legend>
		<div id="dqm_control">
			<table><tr><td>	
				<input class="button" type="button" name="action" style="background-color: #ffff90; font: bold 12px Arial;" value="Init" onClick="return sendDQMAction('Configure');">
				<input class="button" type="button" name="action" style="background-color: #90ff90; font: bold 12px Arial;" value="Start" onClick="return sendDQMAction('Enable');">
				<input class="button" type="button" name="action" style="background-color: #ff9090; font: bold 12px Arial;" value="Stop" onClick="return sendDQMAction('Halt');"></td>				
			</tr></table>		
			
		</div>
	</fieldset>
	
	
	
	<fieldset id="Runs">
		<legend>
			<a class='winTitle' href='#' onClick='showHide("runs_list");'>Runs</a>
		</legend>
		<div id="runs_list">
			<script type="text/javascript">			
			<!--//
				// setSelectedResultsFolder();
				getRunsList();
			//-->
			</script>
		</div>
	</fieldset>
	
	
	<fieldset id="Tests">
		<legend>
			<a class='winTitle' href='' onClick='return showHide("tests_div");'>Tests</a>
		</legend>
		<div id="tests_div">
			<script type="text/javascript">
			<!--//
				loadCSCList();
				loadTestsList (TREE_ITEMS, "tests_div");
				
			//-->
			</script>
		</div>
	</fieldset>
	
	<fieldset id="Options">
		<legend><a class='winTitle' href='' onClick='return showHide("options_div");'>Options</a></legend>
		<div id="options_div">
			<table>
				<tr>
					<td><label>Plot Width:</label> 
					<input type=button name="decWidth" value="-" onclick="decImageWidth();">    		     
					<script type="text/javascript"> 
						document.write("<input type=text readonly id='imageWidth' align=right value='"+imgWidth+"' size='4'>"); 		 
					</script>
					<input type=button name="incWidth" value="+" onclick="incImageWidth()">    
			      </td>
				</tr>
				<tr>
					<td><label>Plot Height:</label> 
					<input type=button name="decHeight" value="-" onclick="decImageHeight();">    		     
					<script type="text/javascript"> 
						document.write("<input type=text readonly id='imageHeight' align=right value='"+imgHeight+"' size='4'>"); 		 
					</script>
					<input type=button name="incHeight" value="+" onclick="incImageHeight()">    
			      </td>
				</tr>
				<tr>
				  <td>
					<label>Open in External Window</label></label> <input type=checkbox  id="openExternal" onclick="selectPlotMode()">  
				  </td>
			   </tr>
			   <tr>
				  <td>
					<label>Show Reference Plots</label></label> <input type=checkbox  id="showReference" onclick="selectShowReferenceMode()">  
				  </td>
			   </tr>
			   <tr>
				  <td>
					<label>Auto Update</label></label> <input type=checkbox  id="autoUpdateMode" onclick="selectUpdateMode()">  
				  </td>
			   </tr>
			</table>
		</div>
	</fieldset>
	
	<fieldset id="SlideShow">
		<legend><a class='winTitle' href='' onClick='return showHide("slideshow_div");'>SlideShow</a></legend>
		<div id="slideshow_div">
			<form name="theTimer"><table>
			<tr>
				<td colspan=3>
				
				<script type="text/javascript"> 
			<!--//
				initSlideShowList();
				
			//-->
				</script>
				
				</td>
			</tr>
		   <tr>      
			  <td colspan=3 align=center>
				<!-- input type=text name="currentTest" -->
				<span id="currentTest"></span>
			  </td>
		   </tr>
		   <tr>
		      <td>
				 <input type=button name="prev" value="<" onclick="showPrevSlide()">    
		         <input type=button name="start" value="Start" onclick="startSlideShow()">      
		         <input type=button name="stop" value="Stop" onclick="stopSlideShow()">
		         <input type=button name="reset" value="Reset" onclick="resetSlideShow()">
				 <input type=button name="next" value=">" onclick="showNextSlide()">    
				 <input type=text id="updateInterval" value="5" size="2"> 		 
		      </td>
		   </tr>
			</table></form>
			
			<div id="slideshow_list">
			</div>

		</div>
	</fieldset>
	
</td><td style='border: 0px black solid;'>	

	<fieldset id="NodesView">
		<legend>
			<a class='winTitle' href='' onClick='return showHide("nodes_div");'>Nodes Status</a>						
		</legend>
		<div id="nodes_div">
			<div id="nodesview_div">
				<script type="text/javascript">
					<!--//
						getNodesList();					
					//-->
				</script>
			</div>
			<div id='sysstatus_div'>
				<script type="text/javascript">
					<!--//
						 updateSysStatus();					
					//-->
				</script>
			</div>
			<div id='nodestatus_div' style='display:none'></div>
			
		</div>
	</fieldset>
	<fieldset id="SystemView">
		<legend>
			<a class='winTitle' href='' onClick='return showHide("sysview_div");'>System View</a>
		</legend>		
		<div id="sysview_div">	
			<div class="tabs">
				<ul>
				<li title="csc_view" id="selected" onClick="return setSelectedTab(this);"><a href="">CSCs Table</a></li>
				<li title="hw_view"   onClick="return setSelectedTab(this);"><a href="">VME/DMB Table</a></li>
				<li title="ddu_view"  onClick="return setSelectedTab(this);"><a href="">DDU/CSC Map</a></li>
				<li title="csccounters_view"   onClick="return setSelectedTab(this);"><a href="">CSC Efficiencies</a></li>
				<li title="report_view"  onClick="return setSelectedTab(this);"><a href="#">Summary Report</a></li>
				</ul>
			</div>
			
			<div id="csctable_div" >
				<script type="text/javascript">
				<!--//
					// new showCSCTable("csctable_div");
					showCSCTable("csctable_div");					
				//-->
				</script>
			</div>
				
			<div id="hwtable_div" style="display: none;">
				Empty HW Table
			</div>			
			<div id="ddutable_div" style="display: none;">
				<script type="text/javascript">
				<!--//
					// new showCSCTable("csctable_div");
					showDDUTable("ddutable_div");
				//-->
				</script>
			</div>
			<div id="csccounters_div" style="display: none;">
				<script type="text/javascript">
				<!--//
					getCSCCounters();
				//-->
				</script>
			</div>
			<div id="nodes_div" style="display: none;">
				Empty
			</div>
			<div id="report_div" style="display: none;">
				<script type="text/javascript">
				<!--//
					getDQMReport();
				//-->
				</script>				
			</div>
		</div>
		
	</fieldset>
	
	<fieldset id="StatusEntry">	
		<legend><a id='report_title' class='winTitle' href='#' onClick='showHide("report_entry_div");'>Report Status</a></legend>
		<div id="report_entry_div">		
		</div>	
	</fieldset>	
	
	<fieldset id="Plots">
		<legend><a id='plot_title' class='winTitle' href='' onClick='return showHide("plots_div");'>Plots</a></legend>
		<div id="plots_div">
		</div>
	</fieldset>

</td></tr>
<tr style='border: 0px black solid;'><td colspan=2 style='border: 0px black solid;'>
	
	<fieldset>
		<legend><a class='winTitle' href='' onClick='return showHide("log");'>Log</a>
			<input type=button value="Clear" onclick="clearLog();"> 
			<select id="selLogLevel" onChange="selectLogLevel()";>	
				<option selected value="all">ALL</option>
				<option value="debug">DEBUG</option>			
				<option value="info">INFO</option>
				<option value="warn">WARNING</option>
				<option value="error">ERROR</option>
				
			</select>
		</legend>
		<table>
		<div id="log">
		</div>
		</table>
	</fieldset>

</td></tr>
</table>		
	
</body>
</html>
